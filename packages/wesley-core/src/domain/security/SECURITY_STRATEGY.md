# Wesley Security Strategy

## ğŸ¯ Production Security Approach

Wesley uses **defense in depth** with industry-standard libraries and patterns.

## ğŸ›¡ï¸ Security Layers

### 1. **Supabase-js Integration (RECOMMENDED)**

For production deployments, Wesley schemas work with Supabase's battle-tested security:

```javascript
import { createClient } from '@supabase/supabase-js'

// âœ… GOLD STANDARD: Supabase handles all security internally
const supabase = createClient(url, key)

// âœ… Built-in parameterization and RLS enforcement
const { data } = await supabase
  .from('users')
  .select('*')
  .eq('id', userId)  // Automatically parameterized
```

### 2. **Parameterized Queries (CORE PATTERN)**

For direct PostgreSQL operations:

```javascript
// âœ… SECURE: Parameters are escaped automatically
const result = await client.query(
  'SELECT * FROM users WHERE email = $1 AND org_id = $2',
  [email, orgId]
);

// âŒ VULNERABLE: String interpolation
const result = await client.query(
  `SELECT * FROM users WHERE email = '${email}'`  // SQL INJECTION RISK
);
```

### 3. **Schema Generation Security (Wesley-specific)**

Since DDL can't be parameterized, Wesley validates + escapes:

```javascript
// âœ… VALIDATED: Wesley checks identifiers before generation
validateSQLIdentifier(tableName, 'table name');
const sql = `CREATE TABLE ${escapeIdentifier(tableName)} (...)`;

// âœ… TEMPLATE APPROACH: Even safer
const sql = buildDDL(DDL_TEMPLATES.CREATE_TABLE, {
  table: tableName  // Validated and quoted automatically
});
```

### 4. **RLS Policy Security**

Wesley generates RLS policies that integrate with Supabase auth:

```sql
-- âœ… WESLEY-GENERATED: Safe RLS patterns
CREATE POLICY "users_own_data" ON users
  FOR ALL TO authenticated
  USING (auth.uid() = user_id);

-- âŒ DANGEROUS: Never generated by Wesley  
CREATE POLICY "bypass_all" ON users
  FOR ALL TO authenticated  
  USING (true);  -- Bypasses all security
```

## ğŸ§ª Security Testing

Wesley includes comprehensive security test suites:

- **SQL injection prevention** - 20+ attack vectors tested
- **Parameter validation** - Edge cases and dangerous patterns
- **RLS policy validation** - Prevents bypass attempts  
- **Input sanitization** - Standard PostgreSQL escaping

## ğŸ“‹ Security Checklist

### For Wesley Schema Authors
- âœ… Use Wesley directives (@table, @rls, @check) - they're validated
- âœ… Define RLS policies in GraphQL - Wesley ensures they're safe
- âŒ Never include raw SQL in schema comments or descriptions

### For Wesley Runtime Users  
- âœ… **PREFER**: Supabase-js client for all data operations
- âœ… **FALLBACK**: Parameterized queries with pg library
- âŒ **NEVER**: String interpolation or template literals with user data

### For Production Deployment
- âœ… All Wesley-generated SQL is pre-validated for security
- âœ… RLS policies are auto-enabled on all @rls tables
- âœ… Check constraints are validated for dangerous patterns
- âœ… Advisory locks prevent concurrent migration conflicts

## ğŸ”— Related Security Resources

- [Supabase Auth Documentation](https://supabase.com/docs/guides/auth)
- [PostgreSQL Security Best Practices](https://www.postgresql.org/docs/current/security.html)
- [OWASP SQL Injection Prevention](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)

## ğŸš¨ Security Contact

Found a security issue? Please report it privately to the maintainers rather than opening a public issue.

---

**Wesley's Philosophy**: *Be the "adult in the room" for database security - no surprises, no vulnerabilities, just boring reliability.*
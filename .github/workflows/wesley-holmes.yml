name: ðŸ” Wesley + SHA-lock HOLMES CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  wesley-generate:
    name: "ðŸš€ Wesley Generation"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¦ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: "ðŸ”§ Setup pnpm"
        uses: pnpm/action-setup@v4
          
      - name: "ðŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: "ðŸ“¦ Install Dependencies"
        run: pnpm install
        
      - name: "ðŸš€ Generate Artifacts"
        env:
          WESLEY_OUT_DIR: out
        run: |
          cd example
          # Use workspace binary directly to avoid PATH/bin resolution issues
          # Explicit out dir to align with downstream pgTAP apply step
          node ../packages/wesley-host-node/bin/wesley.mjs generate \
            --schema schema.graphql \
            --emit-bundle \
            --ops ../example/ops \
            --allow-dirty \
            --out-dir "$WESLEY_OUT_DIR"
          
      - name: "ðŸ“Š Display Scores"
        run: |
          echo "## ðŸ“Š Generation Scores"
          if [ -f example/.wesley/scores.json ]; then
            cat example/.wesley/scores.json | jq '.scores'
          elif [ -f .wesley/scores.json ]; then
            cat .wesley/scores.json | jq '.scores'
          else
            echo "No scores.json found yet"
          fi
          
      - name: "ðŸ“¦ Prepare Bundle for Upload"
        run: |
          if [ -f example/.wesley/bundle.json ]; then
            echo "Bundle already under example/.wesley"
          elif [ -f .wesley/bundle.json ]; then
            echo "Copying root .wesley to example/.wesley for artifact upload"
            mkdir -p example/.wesley
            cp -R .wesley/. example/.wesley/
          else
            echo "âŒ Bundle not found in expected locations"
            ls -la
            ls -la example || true
            exit 1
          fi

      - name: "ðŸ’¾ Upload Bundle"
        uses: actions/upload-artifact@v4
        with:
          name: wesley-bundle
          path: example/.wesley/
          
  holmes-investigate:
    name: "ðŸ” HOLMES Investigation"
    runs-on: ubuntu-latest
    needs: wesley-generate
    
    steps:
      - name: "ðŸ“¦ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ”§ Setup pnpm"
        uses: pnpm/action-setup@v4
        
      - name: "ðŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: "ðŸ“¦ Install HOLMES"
        run: pnpm install
        
      - name: "ðŸ“¥ Download Bundle (if available)"
        id: download-bundle
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wesley-bundle
          path: example/.wesley/

      - name: "ðŸ”Ž Ensure Bundle (fallback generate if missing)"
        run: |
          if [ ! -f example/.wesley/bundle.json ]; then
            echo "Bundle not found. Regenerating..."
            cd example
            node ../packages/wesley-host-node/bin/wesley.mjs generate --schema schema.graphql --emit-bundle --allow-dirty --ops ../example/ops --out-dir out
            cd -
          else
            echo "Bundle found at example/.wesley/bundle.json"
          fi
          
      - name: "ðŸ” Run Investigation"
        id: holmes
        run: |
          cd example
          # Run HOLMES from workspace package
          node ../packages/wesley-holmes/src/cli.mjs investigate > holmes-report.md
          cat holmes-report.md
          
      - name: "ðŸ’¾ Save Report"
        uses: actions/upload-artifact@v4
        with:
          name: holmes-report
          path: example/holmes-report.md
          
  watson-verify:
    name: "ðŸ©º WATSON Verification"
    runs-on: ubuntu-latest
    needs: holmes-investigate
    
    steps:
      - name: "ðŸ“¦ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ”§ Setup pnpm"
        uses: pnpm/action-setup@v4
        
      - name: "ðŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: "ðŸ“¦ Install HOLMES"
        run: pnpm install
        
      - name: "ðŸ“¥ Download Bundle (if available)"
        id: download-bundle
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wesley-bundle
          path: example/.wesley/

      - name: "ðŸ”Ž Ensure Bundle (fallback generate if missing)"
        run: |
          if [ ! -f example/.wesley/bundle.json ]; then
            echo "Bundle not found. Regenerating..."
            cd example
            node ../packages/wesley-host-node/bin/wesley.mjs generate --schema schema.graphql --emit-bundle --allow-dirty --ops ../example/ops --out-dir out
            cd -
          else
            echo "Bundle found at example/.wesley/bundle.json"
          fi
          
      - name: "ðŸ©º Run Verification"
        id: watson
        run: |
          cd example
          node ../packages/wesley-holmes/src/cli.mjs verify > watson-report.md
          cat watson-report.md
          
      - name: "ðŸ’¾ Save Report"
        uses: actions/upload-artifact@v4
        with:
          name: watson-report
          path: example/watson-report.md
          
  moriarty-predict:
    name: "ðŸ”® MORIARTY Predictions"
    runs-on: ubuntu-latest
    needs: watson-verify
    
    steps:
      - name: "ðŸ“¦ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ”§ Setup pnpm"
        uses: pnpm/action-setup@v4
        
      - name: "ðŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          
      - name: "ðŸ“¦ Install HOLMES"
        run: pnpm install
        
      - name: "ðŸ“¥ Download Bundle (if available)"
        id: download-bundle
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wesley-bundle
          path: example/.wesley/

      - name: "ðŸ”Ž Ensure Bundle (fallback generate if missing)"
        run: |
          if [ ! -f example/.wesley/bundle.json ]; then
            echo "Bundle not found. Regenerating..."
            cd example
            node ../packages/wesley-host-node/bin/wesley.mjs generate --schema schema.graphql --emit-bundle --allow-dirty --ops ../example/ops --out-dir out
            cd -
          else
            echo "Bundle found at example/.wesley/bundle.json"
          fi
          
      - name: "ðŸ”® Run Predictions"
        id: moriarty
        run: |
          cd example
          node ../packages/wesley-holmes/src/cli.mjs predict > moriarty-report.md || echo "Insufficient data for predictions" > moriarty-report.md
          cat moriarty-report.md
          
      - name: "ðŸ’¾ Save Report"
        uses: actions/upload-artifact@v4
        with:
          name: moriarty-report
          path: example/moriarty-report.md
          
  test-pgtap:
    name: "ðŸ§ª pgTAP Tests"
    runs-on: ubuntu-latest
    needs: wesley-generate
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
    steps:
      - name: "ðŸ“¦ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ”§ Setup pnpm"
        uses: pnpm/action-setup@v4

      - name: "ðŸ”§ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: "ðŸ“¦ Install Workspace"
        run: pnpm install

      - name: "ðŸ“¥ Download Bundle (if available)"
        id: download-bundle
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: wesley-bundle
          path: example/.wesley/

      - name: "ðŸ”Ž Ensure Bundle (fallback generate if missing)"
        run: |
          if [ ! -f example/.wesley/bundle.json ]; then
            echo "Bundle not found. Regenerating..."
            cd example
            node ../packages/wesley-host-node/bin/wesley.mjs generate --schema schema.graphql --emit-bundle --allow-dirty --ops ../example/ops --out-dir out
            cd -
          else
            echo "Bundle found at example/.wesley/bundle.json"
          fi
          
      - name: "ðŸ§ª Install pgTAP"
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client
      
      - name: "ðŸ“¦ Install pgTAP into Postgres service"
        run: |
          # Install pgTAP inside the postgres:15 container as root so CREATE EXTENSION works
          set -euo pipefail
          docker exec -u 0 ${{ job.services.postgres.id }} bash -lc '
            set -euo pipefail
            apt-get update
            if apt-get install -y postgresql-15-pgtap; then
              echo "Installed postgresql-15-pgtap"
            elif apt-get install -y pgtap; then
              echo "Installed generic pgtap package"
            else
              echo "Failed to install pgTAP in postgres service" >&2
              exit 1
            fi
          '
          
      - name: "ðŸ”¨ Apply Schema"
        env:
          WESLEY_OUT_DIR: out
        run: |
          # Apply the generated schema produced in the generation step
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -f "example/${WESLEY_OUT_DIR}/schema.sql"

      - name: "ðŸ—ï¸ Ensure wes_ops schema"
        run: |
          # Ops emission targets schema wes_ops; create it if missing
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -c 'CREATE SCHEMA IF NOT EXISTS wes_ops;'
      
      - name: "ðŸ“¦ Apply Ops SQL (views/functions)"
        env:
          WESLEY_OUT_DIR: out
        run: |
          set -euo pipefail
          OPS_DIR="example/${WESLEY_OUT_DIR}/ops"
          shopt -s nullglob
          if [ ! -d "$OPS_DIR" ]; then
            echo "No ops SQL directory found; skipping"
            exit 0
          fi
          files=("$OPS_DIR"/*.sql)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No ops SQL files found; nothing to apply"
            exit 0
          fi
          for f in "${files[@]}"; do
            if [ ! -s "$f" ]; then
              echo "Skipping empty file: $f"
              continue
            fi
            echo "Applying $f in a transaction..."
            tmp=$(mktemp)
            { echo 'BEGIN;'; cat "$f"; echo 'COMMIT;'; } > "$tmp"
            PGPASSWORD=postgres psql -v ON_ERROR_STOP=1 -h localhost -U postgres -d test -f "$tmp"
            rm -f "$tmp"
          done

      - name: "ðŸŒ± Seed minimal data for ops"
        run: |
          # Seed a couple of products (one published, one not)
          PGPASSWORD=postgres psql -h localhost -U postgres -d test <<'SQL'
          insert into product (id, sku, name, slug, price_cents, stock_quantity, published, created_at)
          values (gen_random_uuid(), 'SKU1', 'Alpha', 'alpha', 100, 10, true, now())
          on conflict do nothing;
          insert into product (id, sku, name, slug, price_cents, stock_quantity, published, created_at)
          values (gen_random_uuid(), 'SKU2', 'Beta', 'beta', 200, 0, false, now())
          on conflict do nothing;
          SQL

      - name: "ðŸ§ª Generate EXPLAIN JSON snapshots"
        env:
          WESLEY_OUT_DIR: out
        run: |
          set -euo pipefail
          mkdir -p example/${WESLEY_OUT_DIR}/ops/explain
          # EXPLAIN (FORMAT JSON) for function calls
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -t -A -c "EXPLAIN (FORMAT JSON) SELECT * FROM wes_ops.op_products_by_name('Al%')" > example/${WESLEY_OUT_DIR}/ops/explain/products_by_name.explain.json
          PGPASSWORD=postgres psql -h localhost -U postgres -d test -t -A -c "EXPLAIN (FORMAT JSON) SELECT * FROM wes_ops.op_orders_by_user('00000000-0000-0000-0000-000000000000')" > example/${WESLEY_OUT_DIR}/ops/explain/orders_by_user.explain.json

      - name: "â¬†ï¸ Upload EXPLAIN snapshots"
        uses: actions/upload-artifact@v4
        with:
          name: ops-explain
          path: example/out/ops/explain/

      - name: "ðŸ§ª Run Tests"
        run: |
          # Run ops pgTAP smoke only if pgTAP is available
          HAS_PGTAP=$(PGPASSWORD=postgres psql -h localhost -U postgres -d test -t -A -c "SELECT 1 FROM pg_available_extensions WHERE name='pgtap'" || echo '')
          if [ "$HAS_PGTAP" = "1" ]; then
            PGPASSWORD=postgres psql -v ON_ERROR_STOP=1 -h localhost -U postgres -d test -f example/tests/ops.pgtap.sql
          else
            echo "pgtap extension not available; skipping pgTAP tests"
          fi
          # Simple non-pgTAP assertion: expect exactly 1 published product matching 'Al%'
          CNT=$(PGPASSWORD=postgres psql -v ON_ERROR_STOP=1 -h localhost -U postgres -d test -t -A -c "SELECT count(*) FROM wes_ops.op_products_by_name('Al%')" || echo 0)
          echo "Count from op_products_by_name('Al%') = $CNT"
          if [ "$CNT" != "1" ]; then
            echo "Expected 1 row from products_by_name, got $CNT" >&2
            exit 1
          fi
          
  comment-report:
    name: "ðŸ“ Post Investigation Report"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [holmes-investigate, watson-verify, moriarty-predict]
    
    permissions:
      pull-requests: write
      
    steps:
      - name: "ðŸ“¥ Download Reports"
        uses: actions/download-artifact@v4
        
      - name: "ðŸ“ Create Comment"
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const holmes = fs.readFileSync('holmes-report/holmes-report.md', 'utf8');
            const watson = fs.readFileSync('watson-report/watson-report.md', 'utf8');
            const moriarty = fs.readFileSync('moriarty-report/moriarty-report.md', 'utf8');
            
            const body = `
            # ðŸ” The Case of Pull Request #${{ github.event.pull_request.number }}
            
            ## ðŸ•µï¸ SHA-lock HOLMES's Investigation
            ${holmes}
            
            ---
            
            ## ðŸ©º Dr. WATSON's Verification
            ${watson}
            
            ---
            
            ## ðŸ”® Professor MORIARTY's Predictions
            ${moriarty}
            
            ---
            *Filed at 221B Repository Street*
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('The Case of Pull Request')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

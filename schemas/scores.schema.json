{
  "$id": "https://wesley.dev/schema/scores-2.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "Wesley Scores v2",
  "type": "object",
  "required": [
    "version",
    "commit",
    "timestamp",
    "scores",
    "thresholds",
    "readiness",
    "metadata"
  ],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^2\\.[0-9]+\\.[0-9]+$"
    },
    "commit": {
      "type": "string",
      "minLength": 7
    },
    "timestamp": {
      "type": "string",
      "format": "date-time"
    },
    "scores": {
      "type": "object",
      "required": ["scs", "tci", "mri", "breakdown"],
      "properties": {
        "scs": { "$ref": "#/$defs/scoreValue" },
        "tci": { "$ref": "#/$defs/scoreValue" },
        "mri": { "$ref": "#/$defs/scoreValue" },
        "breakdown": {
          "type": "object",
          "required": ["scs", "tci", "mri"],
          "properties": {
            "scs": {
              "type": "object",
              "required": ["sql", "types", "validation", "tests"],
              "properties": {
                "sql": { "$ref": "#/$defs/scsBreakdownEntry" },
                "types": { "$ref": "#/$defs/scsBreakdownEntry" },
                "validation": { "$ref": "#/$defs/scsBreakdownEntry" },
                "tests": { "$ref": "#/$defs/scsBreakdownEntry" }
              },
              "additionalProperties": true
            },
            "tci": {
              "type": "object",
              "required": ["unitConstraints", "rls", "integrationRelations", "e2eOps"],
              "properties": {
                "unitConstraints": { "$ref": "#/$defs/tciBreakdownEntry" },
                "rls": { "$ref": "#/$defs/tciBreakdownEntry" },
                "integrationRelations": { "$ref": "#/$defs/tciBreakdownEntry" },
                "e2eOps": { "$ref": "#/$defs/tciBreakdownEntry" }
              },
              "additionalProperties": true
            },
            "mri": {
              "type": "object",
              "properties": {
                "drops": { "$ref": "#/$defs/mriBreakdownEntry" },
                "renames": { "$ref": "#/$defs/mriBreakdownEntry" },
                "defaults": { "$ref": "#/$defs/mriBreakdownEntry" },
                "typeChanges": { "$ref": "#/$defs/mriBreakdownEntry" },
                "indexes": { "$ref": "#/$defs/mriBreakdownEntry" },
                "other": { "$ref": "#/$defs/mriBreakdownEntry" }
              },
              "additionalProperties": true
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "thresholds": {
      "type": "object",
      "required": ["scs", "tci", "mri"],
      "properties": {
        "scs": { "$ref": "#/$defs/scoreValue" },
        "tci": { "$ref": "#/$defs/scoreValue" },
        "mri": { "$ref": "#/$defs/scoreValue" }
      },
      "additionalProperties": false
    },
    "readiness": {
      "type": "object",
      "required": ["ready", "verdict", "scs", "tci", "mri"],
      "properties": {
        "ready": { "type": "boolean" },
        "verdict": { "type": "string" },
        "scs": { "$ref": "#/$defs/readinessGate" },
        "tci": { "$ref": "#/$defs/readinessGate" },
        "mri": { "$ref": "#/$defs/readinessGate" }
      },
      "additionalProperties": true
    },
    "metadata": {
      "type": "object",
      "required": ["tables", "migrationSteps", "testsRun"],
      "properties": {
        "tables": { "type": "integer", "minimum": 0 },
        "migrationSteps": { "type": "integer", "minimum": 0 },
        "testsRun": { "type": "integer", "minimum": 0 }
      },
      "additionalProperties": true
    }
  },
  "$defs": {
    "scoreValue": {
      "type": "number",
      "minimum": 0,
      "maximum": 1
    },
    "scsBreakdownEntry": {
      "type": "object",
      "required": ["score", "totalWeight", "coveredWeight"],
      "properties": {
        "score": { "$ref": "#/$defs/scoreValue" },
        "totalWeight": { "type": "number", "minimum": 0 },
        "coveredWeight": { "type": "number", "minimum": 0 },
        "kinds": {
          "type": "array",
          "items": { "type": "string" }
        }
      },
      "additionalProperties": true
    },
    "tciBreakdownEntry": {
      "type": "object",
      "required": ["score"],
      "properties": {
        "score": { "$ref": "#/$defs/scoreValue" },
        "total": { "type": "number", "minimum": 0 },
        "covered": { "type": "number", "minimum": 0 },
        "components": {
          "type": "object",
          "properties": {
            "structure": { "$ref": "#/$defs/scoreValue" },
            "constraints": { "$ref": "#/$defs/scoreValue" },
            "defaults": { "$ref": "#/$defs/scoreValue" },
            "indexes": { "$ref": "#/$defs/scoreValue" }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "mriBreakdownEntry": {
      "type": "object",
      "required": ["score", "points", "contribution"],
      "properties": {
        "score": { "$ref": "#/$defs/scoreValue" },
        "points": { "type": "number", "minimum": 0 },
        "contribution": { "$ref": "#/$defs/scoreValue" }
      },
      "additionalProperties": true
    },
    "readinessGate": {
      "type": "object",
      "required": ["score", "threshold", "pass"],
      "properties": {
        "score": { "$ref": "#/$defs/scoreValue" },
        "threshold": { "$ref": "#/$defs/scoreValue" },
        "pass": { "type": "boolean" }
      },
      "additionalProperties": true
    }
  },
  "additionalProperties": false
}

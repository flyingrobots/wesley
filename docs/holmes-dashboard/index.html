<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wesley HOLMES Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --accent: #1976d2;
      --warn: #ff9800;
      --danger: #d32f2f;
      --success: #2e7d32;
    }
    body {
      margin: 0;
      padding: 2rem;
      background: #f5f7fa;
      color: #1f2933;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid rgba(25, 118, 210, 0.15);
    }
    .brand {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .brand-mark {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }
    .brand-initial {
      display: inline-flex;
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 0.5rem;
      background: linear-gradient(135deg, #1976d2, #42a5f5);
      color: white;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .brand-name {
      font-size: 1rem;
      letter-spacing: 0.18em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }
    .metric {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    .metric:last-child {
      margin-bottom: 0;
    }
    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: #fff;
    }
    .badge.success { background: var(--success); }
    .badge.warn { background: var(--warn); }
    .badge.danger { background: var(--danger); }
    .progress {
      background: rgba(25, 118, 210, 0.15);
      border-radius: 8px;
      overflow: hidden;
      height: 10px;
      flex: 1;
      margin-left: 1rem;
    }
    .progress > span {
      display: block;
      height: 100%;
      background: var(--accent);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.3);
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:hover {
      background: rgba(25, 118, 210, 0.08);
    }
    .status {
      font-size: 1.25rem;
      font-weight: 600;
    }
    .muted {
      color: #64748b;
      font-size: 0.85rem;
    }
    pre {
      background: rgba(15, 23, 42, 0.05);
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <header class="brand">
    <div class="brand-mark">
      <span class="brand-initial">W</span>
      <span class="brand-name">Wesley</span>
    </div>
    <h1>SHA-lock HOLMES Intelligence Briefing</h1>
    <p class="muted">Place this file alongside <code>holmes-report.json</code>, <code>watson-report.json</code>, and <code>moriarty-report.json</code> to visualize the latest investigation.</p>
  </header>

  <section class="grid" id="summary">
    <div class="card" id="verdict-card">
      <h2>Verdict Suite</h2>
      <div id="verdict-holmes"></div>
      <div id="verdict-watson" style="margin-top:1rem"></div>
      <div id="verdict-moriarty" style="margin-top:1rem"></div>
    </div>
    <div class="card" id="metrics-card">
      <h2>SCS / TCI / MRI</h2>
      <div class="metric"><span>SCS</span><div class="progress"><span id="scs-bar"></span></div><span id="scs-value"></span></div>
      <div class="metric"><span>TCI</span><div class="progress"><span id="tci-bar"></span></div><span id="tci-value"></span></div>
      <div class="metric"><span>MRI</span><div class="progress"><span id="mri-bar"></span></div><span id="mri-value"></span></div>
    </div>
    <div class="card" id="velocity-card">
      <h2>Velocity & ETA</h2>
      <div id="velocity-body" class="muted">Awaiting MORIARTY...</div>
    </div>
  </section>

  <section class="card" style="margin-top:2rem">
    <h2>Recent Score History</h2>
    <table>
      <thead>
        <tr><th>Date</th><th>SCS</th><th>TCI</th><th>MRI</th></tr>
      </thead>
      <tbody id="history-body">
        <tr><td colspan="4" class="muted">No history yet.</td></tr>
      </tbody>
    </table>
  </section>

  <section class="card" style="margin-top:2rem">
    <h2>Score Breakdown</h2>
    <div class="grid" id="breakdown-grid">
      <div>
        <h3>SCS</h3>
        <table>
          <thead><tr><th>Component</th><th>Score</th><th>Coverage</th></tr></thead>
          <tbody id="scs-breakdown">
            <tr><td colspan="3" class="muted">No data.</td></tr>
          </tbody>
        </table>
      </div>
      <div>
        <h3>TCI</h3>
        <table>
          <thead><tr><th>Component</th><th>Score</th><th>Coverage</th><th>Notes</th></tr></thead>
          <tbody id="tci-breakdown">
            <tr><td colspan="4" class="muted">No data.</td></tr>
          </tbody>
        </table>
      </div>
      <div>
        <h3>MRI</h3>
        <table>
          <thead><tr><th>Risk</th><th>Score</th><th>Contribution</th><th>Points</th></tr></thead>
          <tbody id="mri-breakdown">
            <tr><td colspan="4" class="muted">No data.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:2rem">
    <h3>Raw JSON</h3>
    <details>
      <summary>holmes-report.json</summary>
      <pre id="holmes-json">not loaded</pre>
    </details>
    <details>
      <summary>watson-report.json</summary>
      <pre id="watson-json">not loaded</pre>
    </details>
    <details>
      <summary>moriarty-report.json</summary>
      <pre id="moriarty-json">not loaded</pre>
    </details>
  </section>

  <script>
    async function loadJSON(name) {
      try {
        const res = await fetch(name);
        if (!res.ok) throw new Error(`${name} ${res.status}`);
        return await res.json();
      } catch (error) {
        console.warn(`Unable to load ${name}:`, error.message);
        return null;
      }
    }

    function setProgress(id, value, format = v => `${Math.round(v * 100)}%`) {
      const bar = document.getElementById(id + '-bar');
      const label = document.getElementById(id + '-value');
      if (!bar || !label) return;
      const normalized = Math.max(0, Math.min(1, value ?? 0));
      bar.style.width = `${normalized * 100}%`;
      label.textContent = format(value ?? 0);
      if (id === 'mri') {
        bar.style.background = normalized < 0.4 ? 'var(--success)' : normalized < 0.7 ? 'var(--warn)' : 'var(--danger)';
      }
    }

    function renderVerdict(container, title, verdict, message) {
      const el = document.getElementById(container);
      if (!el) return;
      el.innerHTML = '';
      const heading = document.createElement('div');
      heading.className = 'status';
      heading.textContent = `${title}: ${verdict ?? '—'}`;
      const body = document.createElement('div');
      body.className = 'muted';
      body.textContent = message ?? '';
      el.appendChild(heading);
      el.appendChild(body);
    }

    function renderVelocity(moriarty) {
      const container = document.getElementById('velocity-body');
      if (!moriarty || !moriarty.velocity) {
        container.textContent = 'Insufficient data for predictions.';
        return;
      }
      const lines = [];
      lines.push(`SCS velocity: ${(moriarty.velocity.recent * 100).toFixed(2)}%/day`);
      lines.push(`Blended slope: ${(moriarty.velocity.blendedSlope * 100).toFixed(2)}%/day`);
      if (moriarty.eta) {
        lines.push(`ETA optimistic: ${moriarty.eta.optimistic} days (${moriarty.eta.optimisticDate})`);
        lines.push(`ETA realistic: ${moriarty.eta.realistic} days (${moriarty.eta.realisticDate})`);
        lines.push(`ETA pessimistic: ${moriarty.eta.pessimistic} days (${moriarty.eta.pessimisticDate})`);
        if (typeof moriarty.confidence === 'number') {
          lines.push(`Confidence: ${Math.round(moriarty.confidence)}%`);
        }
      } else {
        lines.push('ETA unavailable — progress plateaued.');
      }
      if (moriarty.plateauDetected) lines.push('⚠️ Plateau detected');
      if (moriarty.regressionDetected) lines.push('🚨 Regression detected');
      container.innerHTML = lines.map(line => `<div>${line}</div>`).join('');
    }

    function renderHistory(history) {
      const tbody = document.getElementById('history-body');
      tbody.innerHTML = '';
      if (!history || history.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.className = 'muted';
        cell.textContent = 'No historical points available. Run generate multiple times to build history.';
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }
      history.forEach(point => {
        const row = document.createElement('tr');
        const dateCell = document.createElement('td');
        const date = point.timestamp ? new Date(point.timestamp) : null;
        dateCell.textContent = date ? date.toISOString().slice(0, 10) : '—';
        const scsCell = document.createElement('td');
        scsCell.textContent = `${Math.round((point.scs ?? 0) * 100)}%`;
        const tciCell = document.createElement('td');
        tciCell.textContent = `${Math.round((point.tci ?? 0) * 100)}%`;
        const mriCell = document.createElement('td');
        mriCell.textContent = `${Math.round((point.mri ?? 0) * 100)}%`;
        row.append(dateCell, scsCell, tciCell, mriCell);
        tbody.appendChild(row);
      });
    }

    function renderRaw(id, data) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = data ? JSON.stringify(data, null, 2) : 'not loaded';
    }

    function formatPercent(value) {
      return typeof value === 'number' && Number.isFinite(value) ? `${(value * 100).toFixed(1)}%` : '—';
    }

    function renderBreakdown(breakdown) {
      renderScsBreakdown(breakdown?.scs);
      renderTciBreakdown(breakdown?.tci);
      renderMriBreakdown(breakdown?.mri);
    }

    function renderScsBreakdown(data) {
      const tbody = document.getElementById('scs-breakdown');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!data || Object.keys(data).length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 3;
        cell.className = 'muted';
        cell.textContent = 'No breakdown data.';
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }
      for (const [key, entry] of Object.entries(data)) {
        const row = document.createElement('tr');
        const coverage = entry?.totalWeight > 0
          ? `${formatPercent((entry.coveredWeight || 0) / entry.totalWeight)} (${(entry.coveredWeight || 0).toFixed(1)}/${entry.totalWeight.toFixed(1)})`
          : '—';
        row.innerHTML = `<td>${labelize(key)}</td><td>${formatPercent(entry?.score)}</td><td>${coverage}</td>`;
        tbody.appendChild(row);
      }
    }

    function renderTciBreakdown(data) {
      const tbody = document.getElementById('tci-breakdown');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!data || Object.keys(data).length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.className = 'muted';
        cell.textContent = 'No breakdown data.';
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }
      for (const [key, entry] of Object.entries(data)) {
        const coverage = entry?.total > 0
          ? `${formatPercent((entry.covered || 0) / entry.total)} (${(entry.covered || 0).toFixed(1)}/${entry.total.toFixed(1)})`
          : '—';
        const notes = entry?.components
          ? Object.entries(entry.components)
              .map(([name, value]) => `${labelize(name)} ${formatPercent(value)}`)
              .join(', ')
          : '—';
        const row = document.createElement('tr');
        row.innerHTML = `<td>${labelize(key)}</td><td>${formatPercent(entry?.score)}</td><td>${coverage}</td><td>${notes}</td>`;
        tbody.appendChild(row);
      }
    }

    function renderMriBreakdown(data) {
      const tbody = document.getElementById('mri-breakdown');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!data || Object.keys(data).length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 4;
        cell.className = 'muted';
        cell.textContent = 'No breakdown data.';
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }
      for (const [key, entry] of Object.entries(data)) {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${labelize(key)}</td><td>${formatPercent(entry?.score)}</td><td>${formatPercent(entry?.contribution)}</td><td>${(entry?.points ?? 0).toFixed(1)}</td>`;
        tbody.appendChild(row);
      }
    }

    function labelize(value) {
      return String(value || '')
        .replace(/([a-z])([A-Z])/g, '$1 $2')
        .replace(/_/g, ' ')
        .replace(/^./, (m) => m.toUpperCase());
    }

    (async () => {
      const holmes = await loadJSON('holmes-report.json');
      const watson = await loadJSON('watson-report.json');
      const moriarty = await loadJSON('moriarty-report.json');

      renderRaw('holmes-json', holmes);
      renderRaw('watson-json', watson);
      renderRaw('moriarty-json', moriarty);

      if (holmes) {
        setProgress('scs', holmes.scores?.scs ?? 0);
        setProgress('tci', holmes.scores?.tci ?? 0);
        setProgress('mri', holmes.scores?.mri ?? 0, v => `${Math.round((v ?? 0) * 100)}%`);
        renderVerdict('verdict-holmes', 'HOLMES', holmes.verdict?.code, holmes.verdict?.message);
        renderBreakdown(holmes.breakdown);
      }

      if (watson) {
        renderVerdict('verdict-watson', 'WATSON', watson.opinion?.verdict, watson.opinion?.message);
      }

      if (moriarty) {
        renderVerdict('verdict-moriarty', 'MORIARTY', moriarty.status, moriarty.message ?? '');
        renderVelocity(moriarty);
        renderHistory(moriarty.history);
      }
    })();
  </script>
</body>
</html>

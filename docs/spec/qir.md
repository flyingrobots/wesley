# QIR Specification (Wesley Query Intermediate Representation)

Status: Draft (synchronized with `schemas/qir.schema.json`).

- Canonical JSON Schema: `schemas/qir.schema.json`
- Purpose: Capture the relational essence of a GraphQL operation selection so it can be deterministically lowered to SQL.
- Producer(s): op→plan builder(s), future GraphQL operation compiler
- Consumer(s): `lowerToSQL`, emission wrappers (`emitFunction`, `emitView`)

## Top Level
- `QueryPlan` object
  - `root`: `RelationNode` (Table | Join | Subquery | Lateral | Filter)
  - `projection`: list of `ProjectionItem`s
  - `orderBy?`: list of `OrderBy`
  - `limit?`, `offset?`: integers or null

## Relations
- `Table { kind: 'Table', table, alias }`
- `Join { kind: 'Join', left, right, joinType: 'INNER'|'LEFT', on }`
- `Subquery { kind: 'Subquery', plan, alias }`
- `Lateral { kind: 'Lateral', plan, alias }`
- `Filter { kind: 'Filter', input, predicate }` (normalization wrapper)

## Projection and Expressions
- `Projection.items[]: { alias, expr }`
- `Expr` union: `ColumnRef | ParamRef | Literal | FuncCall | JsonBuildObject | JsonAgg | ScalarSubquery`
- `ParamRef` carries optional `typeHint` and `special` (e.g., auth/tenant)

## Predicates
- `Compare { kind: 'Compare', left, op, right? }` with ops: `eq, ne, lt, lte, gt, gte, like, ilike, contains, in, isNull, isNotNull`
- `Exists { kind: 'Exists', subquery }`
- `Not/And/Or` over `Predicate`

## Ordering
- `OrderBy { expr, direction: 'asc'|'desc', nulls?: 'first'|'last' }`

## Determinism & Identifiers
- Parameter order is collected separately and consumed by `lowerToSQL`.
- Identifiers are rendered per `identPolicy` (minimal|strict) during lowering.
- A `pkResolver` hook can be provided when lowering to derive tie‑breakers from Schema IR (preferred over the `alias.id` heuristic).

## Validation
- Use Ajv against `schemas/qir.schema.json` to validate QIR plans generated by compilers/builders.
- Tests in `@wesley/core` exercise the schema on representative plans.

## Notes
- This spec defines the QIR surface consumed by `lowerToSQL`. It purposefully separates Query IR from the Canonical Schema IR (`schemas/ir.schema.json`). Cross‑references are by name (e.g., `TableNode.table`) and are wired by the lowering environment (e.g., `pkResolver`).


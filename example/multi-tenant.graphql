# Multi-tenant SaaS Example Schema
# Demonstrates Wesley's @tenant and @owner directives

type Org @table {
  id: ID! @primaryKey
  name: String! @unique
  slug: String! @unique @index
  createdAt: DateTime! @default(value: "NOW()")
}

type User @table {
  id: ID! @primaryKey
  email: String! @unique @email
  name: String!
  createdAt: DateTime! @default(value: "NOW()")
}

type Membership @table {
  user_id: ID! @foreignKey(ref: "User.id") @index
  org_id: ID! @foreignKey(ref: "Org.id") @index
  role: MemberRole! @index
  createdAt: DateTime! @default(value: "NOW()")
  
  # Composite primary key
  @@primaryKey(fields: ["user_id", "org_id"])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

# Tenant-scoped resources

type Project @table 
  @tenant(by: "org_id")
  @owner(column: "created_by")
  @rls(enabled: true) {
  id: ID! @primaryKey
  org_id: ID! @foreignKey(ref: "Org.id") @index
  name: String!
  description: String
  created_by: ID! @foreignKey(ref: "User.id") @index
  createdAt: DateTime! @default(value: "NOW()")
  updatedAt: DateTime! @default(value: "NOW()")
}

type Document @table
  @tenant(by: "org_id")
  @owner(column: "created_by")
  @rls(
    enabled: true,
    select: "tenant",
    insert: "tenant_and_owner",
    update: "owner_or_admin",
    delete: "owner_or_admin"
  ) {
  id: ID! @primaryKey
  org_id: ID! @foreignKey(ref: "Org.id") @index
  project_id: ID! @foreignKey(ref: "Project.id") @index
  title: String!
  content: String
  status: DocumentStatus! @default(value: "DRAFT") @index
  created_by: ID! @foreignKey(ref: "User.id") @index
  tags: [String!]!
  metadata: JSON
  createdAt: DateTime! @default(value: "NOW()")
  updatedAt: DateTime! @default(value: "NOW()")
}

enum DocumentStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

# Sharing/collaboration features

type DocumentShare @table {
  id: ID! @primaryKey
  document_id: ID! @foreignKey(ref: "Document.id") @index
  user_id: ID! @foreignKey(ref: "User.id") @index
  can_edit: Boolean! @default(value: "false")
  can_comment: Boolean! @default(value: "true")
  expires_at: DateTime
  created_by: ID! @foreignKey(ref: "User.id")
  createdAt: DateTime! @default(value: "NOW()")
  
  # Ensure unique shares per user/doc
  @@unique(fields: ["document_id", "user_id"])
}

# Activity/audit log

type ActivityLog @table
  @tenant(by: "org_id")
  @rls(
    enabled: true,
    select: "tenant",
    insert: "system_only",
    update: "never",
    delete: "never"
  ) {
  id: ID! @primaryKey
  org_id: ID! @foreignKey(ref: "Org.id") @index
  user_id: ID! @foreignKey(ref: "User.id") @index
  action: String! @index
  resource_type: String! @index
  resource_id: ID! @index
  metadata: JSON
  ip_address: String @sensitive
  user_agent: String
  createdAt: DateTime! @default(value: "NOW()") @index
}

# API Keys for programmatic access

type ApiKey @table
  @tenant(by: "org_id")
  @owner(column: "created_by")
  @rls(
    enabled: true,
    select: "owner_or_admin",
    insert: "admin_only",
    update: "owner_only",
    delete: "owner_or_admin"
  ) {
  id: ID! @primaryKey
  org_id: ID! @foreignKey(ref: "Org.id") @index
  name: String!
  key_hash: String! @sensitive @unique
  last_used_at: DateTime
  expires_at: DateTime
  scopes: [String!]!
  created_by: ID! @foreignKey(ref: "User.id")
  createdAt: DateTime! @default(value: "NOW()")
}